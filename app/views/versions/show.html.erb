

<% @builds = @version.builds.desc('_id').limit(10).reverse! %>
<% @test_cases = @version.test_cases %>

<% graph_hash = Hash.new{ |h,k| h[k] = Hash.new(&h.default_proc) } %>

<div class="container m-t-1 m-b-1">
  <%= link_to new_product_version_test_case_path(@product,@version), class: 'btn btn-outline-primary pull-md-right m-l-1' do %>
    New test_case
  <% end %>
  <%= link_to new_product_version_build_path(@product,@version), class: 'btn btn-outline-primary pull-md-right m-l-1' do %>
    New build
  <% end %>
  <%= link_to new_product_version_category_path(@product,@version), class: 'btn btn-outline-primary pull-md-right m-l-1' do %>
    New category
  <% end %>
  <%= link_to edit_product_version_path(@product,@version), class: 'btn btn-info pull-md-right' do %>
    Edit
  <% end %>
  <h1>Version <%= @version.name %> </h1>
</div>
<div class="table-responsive ">
  <table id="big-mama" class="table table-bordered table-hover big-mama">
    <thead>
      <th class="first-col text-cut"></th>
      <% builds = @version.builds.desc('_id').limit(10).reverse! %>
      <% builds.each do |build| %>
      <th id="build-<%= build.id %>" class="build-head"><%= link_to build.name, product_version_build_path(@product,@version,build), target: "_blank" %></th>
      <% end %>
      
    </thead>
    <tbody>
      <% @version.categories.asc('name').each do |category| %>
        <tr id="cat_-<%= category.id %>"> 
          <td colspan = 11 ><%=link_to category.name,product_version_category_path(@product,@version,category)  %> </td>
        <tr>
        <% @version.test_cases.where(category_id: category.id).asc('name').each do |test_case| %>
          <tr id="test_case-<%= test_case.id %>"> 
            <td class="first-col text-cut" ><%= link_to test_case.name , product_version_test_case_path(@product,@version,test_case)%></td>
            <% builds.each do |build| %>
              <% if !build.report_links.where(test_case: test_case._id).last.nil? %>
                <% rlink = build.report_links.where(test_case: test_case._id).last %>
                <% if rlink.result %>
                  <% graph_hash[build.name]['passed'].instance_of?(Hash) ? graph_hash[build.name]['passed'] = 1 : graph_hash[build.name]['passed'] += 1 %>
                <% else %>
                  <% graph_hash[build.name]['failed'].instance_of?(Hash) ? graph_hash[build.name]['failed'] = 1 : graph_hash[build.name]['failed'] += 1 %>
                <% end %>
                <td id="cell-<%= rlink.report_id %>"> <%= render :partial => 'reports/icon', :locals => {:report => rlink } %>  </td>
              <% else %>
                <td> </td>
              <% end %>
            <% end %>
          </tr>
        <% end %>
      <% end %>
      <% @version.test_cases.asc('name').each do |test_case| %>
      <tr id="test_case-<%= test_case.id %>"> 
        <td class="first-col text-cut" ><%= link_to test_case.name , product_version_test_case_path(@product,@version,test_case)%></td>
        <% builds.each do |build| %>
          <% if !build.report_links.where(test_case: test_case._id).last.nil? %>
            <% rlink = build.report_links.where(test_case: test_case._id).last %>
            <% if rlink.result %>
              <% graph_hash[build.name]['passed'].instance_of?(Hash) ? graph_hash[build.name]['passed'] = 1 : graph_hash[build.name]['passed'] += 1 %>
            <% else %>
              <% graph_hash[build.name]['failed'].instance_of?(Hash) ? graph_hash[build.name]['failed'] = 1 : graph_hash[build.name]['failed'] += 1 %>
            <% end %>
            <td id="cell-<%= rlink.report_id %>"> <%= render :partial => 'reports/icon', :locals => {:report => rlink } %>  </td>
          <% else %>
            <td> </td>
          <% end %>
        <% end %>
      </tr>
      <% end %>
    </tbody>
  </table>
</div>
      
